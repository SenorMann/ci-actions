description: >
  This job bumps the version of your Node project and uploads a build artifact to your specified NPM registry.

parameters:
  app-dir:
    type: string
    default: "~/project"
    description: Path to the directory containing your package.json file. Not needed if package.json lives in the root.
  dry_run:
    type: boolean
    default: false
    description: >
      This parameters indicates that you don't want npm to make any changes and that it should only report what it would have done.
  git_user_email:
    type: env_var_name
    default: GIT_USER_EMAIL
    description: >
      The email for the git account that performs the commit and tags from bumping version.

  git_user_name:
    type: env_var_name
    default: GIT_USER_NAME
    description: >
      The username for the git account that performs the commit and tags from bumping version.

  npm_registry:
    type: env_var_name
    default: NPM_REGISTRY
    description: >
      The NPM registry to upload your build artifact to.

  npm_registry_auth:
    type: env_var_name
    default: NPM_REGISTRY_AUTH
    description: >
      The authentication token for the specified NPM registry account

  npm_registry_email:
    type: env_var_name
    default: NPM_REGISTRY_EMAIL
    description: >
      The email address for the specified NPM registry account.

  node_version:
    type: string
    default: lts
    description: >
      Pick a specific cimg/node image version tag: https://hub.docker.com/r/cimg/node. Defaults to current LTS.

executor:
  name: default

steps:
  - checkout
  - run:
      name: Install NVM
      command: curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.1/install.sh | bash
  - run:
      name: Install specified Node version
      command: |
        nvm install << parameters.node_version>>
        nvm use << parameters.node_version >>
  - run:
      name: Check files
      command: ls -al
  - run:
      name: Configure git username and email
      environment:
        GIT_USER_EMAIL: << parameters.git_user_email >>
        GIT_USER_NAME: << parameters.git_user_name >>
      command: |
        export GIT_USER_EMAIL=${!GIT_USER_EMAIL}
        echo "$GIT_USER_EMAIL"
  - run:
      name: Bump project version and upload artifact
      working_directory: << parameters.app-dir >>
      environment:
        DRY_RUN: << parameters.dry_run >>
        NPM_REGISTRY: ${NPM_REGISTRY}
        NPM_REGISTRY_AUTH: ${<< parameters.npm_registry_auth >>}
        NPM_REGISTRY_EMAIL: << parameters.npm_registry_email >>
      # command: <<include(scripts/bump-version-and-upload-artifact.sh)>>
      command: |
        REGISTRY=${<< parameters.npm_registry >>}
        echo $REGISTRY
        echo << parameters.npm_registry >>